version: "3.7"

volumes:
  brownie: {}
  cache: {}

networks:
  infra_yearn-exporter:
    external: true

x-common-envs: &common-envs
  - SKIP_WALLET_STATS:
  - SENTRY_ENVIRONMENT: ${SENTRY_ENVIRONMENT:-development}
  - SENTRY_RELEASE:
  - SENTRY_DSN:
  - LOG_LEVEL:
  - POOL_SIZE:
  - TX_POOL_SIZE:
  - RESOLUTION:
  - REORG_BUFFER:
  - JSONRPC_BATCH_MAX_SIZE:
  # eth-retry (optional)
  - MAX_RETRIES:
  - MIN_SLEEP_TIME:
  - MAX_SLEEP_TIME:
  # This is a temporary hack that can be removed once deps support eth_hash==0.5.0. Creds to bunny for finding this.
  - ETH_HASH_BACKEND: ${ETH_HASH_BACKEND:-pysha3}

x-common-apy-envs: &common-apy-envs
  - AWS_ACCESS_KEY:
  - AWS_ACCESS_SECRET:
  - AWS_BUCKET:
  - TG_YFIREBOT_GROUP_INTERNAL:
  - TG_YFIREBOT_GROUP_EXTERNAL:
  - TG_YFIREBOT:
  - EXPORT_MODE:

x-common-network-envs: &common-network-envs
  - BROWNIE_NETWORK:
  - WEB3_PROVIDER:
  - EXPLORER:
  - DEFAULT_EXPLORER:
  - ETHERSCAN_TOKEN:
  - XDAISCAN_TOKEN:
  - FTMSCAN_TOKEN:
  - ARBISCAN_TOKEN:
  - OPTISCAN_TOKEN:

x-common-postgres-envs: &common-postgres-envs
  - PGHOST: postgres
  - PGDATABASE: postgres
  - PGUSER: postgres
  - PGPASSWORD: yearn-exporter

x-common-volumes: &common-volumes
  - brownie:/root/.brownie
  - cache:/app/yearn-exporter/cache

services:
  exporter:
    build: .
    image: yearn-exporter
    volumes: *common-volumes
    environment:
      <<: *common-envs
      <<: *common-postgres-envs
      <<: *common-network-envs
    networks:
      - infra_yearn-exporter
    external_links:
      - infra_postgres_1:postgres
      - infra_victoria-metrics_1:victoria-metrics
    restart: on-failure

  apy:
    build: .
    image: yearn-exporter
    volumes: *common-volumes
    environment:
      <<: *common-envs
      <<: *common-network-envs
      <<: *common-apy-envs
    networks:
      - infra_yearn-exporter
    restart: on-failure
